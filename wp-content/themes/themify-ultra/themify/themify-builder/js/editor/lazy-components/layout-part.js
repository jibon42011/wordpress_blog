((t,e,i,a,s)=>{"use strict";t.LayoutPart=class{static cache={};constructor(t){this.id=t}edit(){const o=this.id,r=this.constructor.cache;return new Promise((async(l,_)=>{const d=t.Registry.get(o);if(!d)return void _();await t.LightBox.save(),t.ActionBar.clear();let c=d.el.closest(".active_module"),h=c.tfClass("themify_builder_content")[0],n=h.dataset.postid,u=async()=>{i.body.classList.add("tb_layout_part_edit"),s.document.body.classList.add("tb_layout_part_edit"),t.ToolBar.el.classList.add("tb_layout_part_edit");const o=t.Builder.get(),d=a("","tb_overlay tf_overflow tf_abs tf_w tf_h"),u=[];for(let t=i.tfClass("themify_builder_content-"+n),e=t.length-1;e>-1;--e)t[e].closest(".active_module")?.tfClass("themify-builder-generated-css")[0]?.setAttribute("disabled","disabled");o.el.classList.remove("tb_active_builder"),c.classList.add("tb_active_layout_part"),c.classList.remove("active_module","module");const b=c.closest(".tb_holder"),y=h.offsetHeight,f=b.closest(".module_row");b.classList.add("tb_layout_part_parent"),b.classList.remove("tb_holder"),f.classList.add("tb_active_layout_part_row"),f.parentNode.appendChild(d),this.el=c;let m=new t.Builder(h,t.Helper.correctBuilderData(r[n].builder_data),r[n].custom_css);for(let t=m.el.querySelectorAll("[data-cid]"),e=t.length-1;e>-1;--e)u.push(t[e].dataset.cid);m.el.style.height=y+"px";for(let t=m.el.children,e=t.length-1;e>-1;--e)t[e].dataset.cid||t[e].remove();try{await t.bootstrap(u),m.el.style.height="";try{await t.correctColumnPaddings()}catch(t){}t.Utils.runJs(m.el),t.Registry.trigger(m,"tb_init"),await t.Spinner.showLoader("done"),this.toolbar.getRootNode().host.classList.remove("tf_hide"),t.activeModel=null,this.toolbar.tfOn(e.click,(e=>{e.stopPropagation();const i=e.target;i.closest("a")&&e.preventDefault(),i.closest(".tf_close")?this.close():i.closest(".save")?this.save():i.closest(".layout")?t.ToolBar.initLayout(e):i.closest(".import")?t.ToolBar.initImport(e):i.closest(".export")?t.ToolBar.initExport(e):i.closest(".custom_css")&&t.ToolBar.addCustomCSS(e)})),this.undo=new t.undoManager(this.toolbar.tfClass("undo")[0],this.toolbar.tfClass("redo")[0]),c=m=h=n=null,e.isTouch||d.tfOn("dblclick",(t=>{t.preventDefault(),t.stopImmediatePropagation(),this.save().then((()=>{this.close()}))}),{once:!0}),i.tfId("tb_layout_part_ui")?.removeAttribute("disabled"),l()}catch(e){t.Spinner.showLoader("error"),this.toolbar.getRootNode().host.remove(),this.html=this.toolbar=null,_()}},b=()=>{this.html=t.Helper.cloneDom(c).innerHTML;const e=a("",{id:"tb_small_toolbar_root",class:"tb_disable_sorting tf_w tf_hide"}),s=i.tfId("tmpl-small_toolbar"),o=i.createDocumentFragment(),r=t.ToolBar.el.getRootNode().querySelectorAll("style,#module_toolbar_style,#tf_svg");e.attachShadow({mode:"open"}).appendChild(s.content.cloneNode(!0));for(let t=0;t<r.length;++t)o.appendChild(r[t].cloneNode(!0));e.shadowRoot.prepend(o),this.toolbar=e.shadowRoot.tfId("toolbar"),c.prepend(e)};try{if(void 0===r[n]){const e=await t.LocalFetch({action:"tb_layout_part_swap",bid:n});if(!e.builder_data)throw"Error";r[n]=e,e.used_gs&&(t.GS.styles={...t.GS.styles,...e.used_gs})}b(),u()}catch(e){t.Spinner.showLoader("error"),this.toolbar.getRootNode().host.remove(),this.html=this.toolbar=null,_()}}))}restore(){const a=this,o=a.el.closest(".tb_layout_part_parent"),r=o.closest(".module_row"),l=t.Builder.get();a.toolbar.getRootNode().host.remove(),t.LightBox.close(),a.el.classList.add("active_module","module"),a.el.classList.remove("tb_active_layout_part"),o.classList.add("tb_holder"),o.classList.remove("tb_layout_part_parent"),r.classList.remove("tb_active_layout_part_row"),r.parentNode.tfClass("tb_overlay")[0]?.remove(),l.destroy(),a.undo.destroy(),t.ActionBar.clear(),t.Builder.get().el.classList.add("tb_active_builder","tf_rel"),i.tfId("tb_layout_part_ui").disabled=!0,i.body.classList.remove("tb_layout_part_edit"),s.document.body.classList.remove("tb_layout_part_edit"),t.ToolBar.el.classList.remove("tb_layout_part_edit"),e.trigger("tb_resotre_layout_part"),a.undo=a.html=a.el=t.activeModel=a.cssFile=t.LayoutPart.item=null}async close(){if(!1===t.Builder.get().isSaved&&t.undoManager.hasUndo()){if("yes"!==await t.LiteLightBox.confirm({msg:"layoutEditConfirm"}))return!1}const e="themify_builder_content-"+t.Builder.get().id;if(this.cssFile){t.Spinner.showLoader();const s=t.Registry.get(this.el.dataset.cid);try{await s.visualPreview({unsetKey:!0,...s.get("mod_settings")});const o=s.el.tfClass("themify_builder_content")[0].innerHTML;let r;!0!==this.cssFile&&(r=a("link",{href:this.cssFile,rel:"stylesheet",class:"themify-builder-generated-css"})),this.restore();for(let a=i.tfClass(e),l=a.length-1;l>-1;--l){let e=a[l].closest(".module");for(let t=a[l].children,e=t.length-1;e>-1;--e)"LINK"===t[e].tagName&&t[e].classList.contains("themify-builder-generated-css")&&t[e].remove();r&&e.prepend(r.cloneNode(!0)),s.id!==e.dataset.cid&&(a[l].innerHTML=o,t.Utils.runJs(a[l]))}t.Spinner.showLoader("hide")}catch(e){throw t.Spinner.showLoader("error"),e}}else{this.html&&(this.el.innerHTML=this.html),this.restore();for(let t=i.tfClass(e),a=t.length-1;a>-1;--a)t[a].closest(".active_module")?.tfClass("themify-builder-generated-css")[0]?.removeAttribute("disabled");t.Utils.runJs(this.el)}}async save(){const e=this.toolbar.tfClass("save_wrap")[0].classList;try{if(e.contains("disabled"))throw"isWorking";e.add("disabled"),await t.LightBox.save(),t.Spinner.showLoader();const i=t.Builder.get(),a=i.id,s=this.constructor.cache,o=await i.save();s[a]={builder_data:o.builder_data},i.custom_css&&(s[a].custom_css=i.custom_css),this.cssFile=o.css_file||!0,this.html=null}catch(t){}e.remove("disabled")}},t.OverlayContent=class extends t.LayoutPart{constructor(t){super(t)}}})(tb_app,Themify,document,tb_createElement,window.top);